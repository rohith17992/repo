---
 - hosts: localhost
   gather_facts: False
   become: false
   tasks:
   - ec2_remote_facts:
       region: "{{ region }}"
       aws_access_key: "{{ aws_access_key }}"
       aws_secret_key: "{{ aws_secret_key }}"
       filters:
         #vpc-id: vpc-478d782f
         "tag:Name": "pub"
     register: info

   - debug: msg="{{ info.instances|map(attribute='id')|list }}"

   - set_fact:
      ec2_id: "{{ info.instances|map(attribute='id')|list }}"

   - ec2_metric_alarm:
      name: "MemoryUtilization  - i-0b4b59140b992eed7"
      state: present
      region: "{{ region }}"
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      metric: "Memory % Committed Bytes In Use"
      namespace: "CWAgent"
      statistic: Minimum
      comparison: ">="
      threshold: 0
      period: 60
      evaluation_periods: 1
      description: "This will alarm when a bamboo slave's cpu usage average is more than 3%"
      dimensions: "{'ImageId':'ami-0d0d4f8ea9e3965a6','InstanceId':'i-0b4b59140b992eed7','InstanceType':'t2.micro','objectname':'Memory'}"
      alarm_actions: ["arn:aws:sns:us-west-2:937385968647:vinaynotify"]
      #with_items: "{{ ec2_id }}"
...
