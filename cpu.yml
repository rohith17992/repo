---
 - hosts: localhost
   gather_facts: False
   become: false
   vars:
       foo:
         - node
         - log
         - nj
   tasks:
   - ec2_remote_facts:
       region: ap-south-1
       aws_access_key: ""
       aws_secret_key: ""
       filters:
         #vpc-id: vpc-478d782f
         tag-key: "Name"
         #tag-value: "kube_node"
     register: info
   - debug: msg="{{ info.instances|map(attribute='id')|list }}"
   - set_fact: 
       ec2_id: "{{ info.instances|map(attribute='id')|list }}"
   - set_fact:
       ec2_tag: "{{ info.instances|map(attribute='tags')|list }}"
   - set_fact:
       ec2_tag1: "{{ ec2_tag|map(attribute='Name')|list }}"
   - debug: msg="{{ foo }}"
   - ec2_metric_alarm:
      name: "Status Check Failed - '{{ item.0  }}'"
      state: present
      aws_access_key: ""
      aws_secret_key: ""
      region: ap-south-1
      metric: "CPUUtilization"
      namespace: "AWS/EC2"
      statistic: Average
      comparison: ">"
      threshold: 5
      period: 60
      evaluation_periods: 3
      unit: "Percent"
      description: "This will alarm when a bamboo slave's cpu usage average is more than 3% "
      dimensions: "{'InstanceId': '{{ item.0  }}' }"
     #when: "'{{ item }}' in '{{ item.1 }}'"
     when: "'yes' in '{% for product in  ['node','log','nj'] %} {% if   item.1.find( product ) != -1  %} yes {% else %} no {% endif %} {% endfor %}'"
     #when: "'{% for vhost in '{{ foo }}' %} {% endfor %}' in '{{ item.1 }}'"
     with_together:
        - "{{ ec2_id }}"
        - "{{ ec2_tag1 }}"
...
